<!DOCTYPE html>
<!--suppress RequiredAttributes -->
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>
<div class="snap-grid" th:fragment="maquinas">
  <div class="row">
    <div class="col-3">
      <!-- lavadoras -->
      <div th:each="nro : ${#numbers.sequence(1,3)}" class="row mt-2 mb-2 me-5 user-select-none maquina">
        <div class="card p-0">
          <div th:text="${'Lavadora '+ nro}" class="card-header"></div>
          <div class="card-body">
            <p class="card-text h6 text-muted text-center m-0 p-0">Sin pedido asignado</p>
            <ul class="pedidoAsignado"></ul>
          </div>
        </div>
      </div>
    </div>
    <div class="col-3 ms-n5 me-5">
      <!-- lavadoras -->
      <div th:each="nro : ${#numbers.sequence(1,3)}" class="row mt-2 mb-2 me-5 user-select-none maquina">
        <div class="card p-0">
          <div th:text="${'Lavadora '+ nro}" class="card-header"></div>
          <div class="card-body">
            <p class="card-text h6 text-muted text-center m-0 p-0">Sin pedido asignado</p>
            <ul class="pedidoAsignado"></ul>
          </div>
        </div>
      </div>
    </div>
    <div class="col-3 ms-5 me-n5">
      <!-- secadoras -->
      <div th:each="nro : ${#numbers.sequence(1,3)}" class="row mt-2 mb-2 ms-5 user-select-none maquina">
        <div class="card p-0">
          <div th:text="${'Secadora '+ nro}" class="card-header"></div>
          <div class="card-body">
            <p class="card-text h6 text-muted text-center m-0 p-0">Sin pedido asignado</p>
            <ul class="pedidoAsignado"></ul>
          </div>
        </div>
      </div>
    </div>
    <div class="col-3">
      <!-- secadoras -->
      <div th:each="nro : ${#numbers.sequence(1,3)}" class="row mt-2 mb-2 ms-5 user-select-none maquina">
        <div class="card p-0">
          <div th:text="${'Secadora '+ nro}" class="card-header"></div>
          <div class="card-body">
            <p class="card-text h6 text-muted text-center m-0 p-0">Sin pedido asignado</p>
            <ul class="pedidoAsignado"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div th:fragment="pedidos_js">
  <script src="webjars/interactjs/1.10.17/dist/interact.js"></script>
  <script>
    // scroll para el costado de pedidos
    const scrollContainer = document.querySelector(".container-pedidos");
    scrollContainer.addEventListener("wheel", (evt) => {
      evt.preventDefault();
      scrollContainer.scrollLeft += evt.deltaY;
    });


    // hago pedidos draggables
    var dragging = false;
    var duplicate_pedido;
    function dragMoveListener (event) {
      // permite mover los pedidos
      if(!dragging){
        duplicate_pedido = event.target.cloneNode(true);
        duplicate_pedido.style.filter = 'grayscale(85%)';
        duplicate_pedido.setAttribute('disabled',true);
        event.target.after(duplicate_pedido);
        dragging = true;
      }
      let target = event.target;
      target.style.position = 'absolute';
      target.style.zIndex = '10';

      // keep the dragged position in the data-x/data-y attributes
      let x = parseFloat(target.getAttribute('data-x')) + event.dx;
      let y = parseFloat(target.getAttribute('data-y')) + event.dy;

      // translate the element
      target.style.transform = 'translate(' + x + 'px, ' + y + 'px)'

      // update the position attributes
      target.setAttribute('data-x', x)
      target.setAttribute('data-y', y)
    }
    function setInitialCoords(event){
        event.target.setAttribute('data-x', parseFloat(0));
        event.target.setAttribute('data-y', parseFloat(0));
    }
    function onDropCheck(event){
      if(dragging){ // si no se soltó dentro de una máquina, el duplicado reemplaza el original y borro el original
        duplicate_pedido.style.filter = '';
        duplicate_pedido.removeAttribute('disabled');
        interact(duplicate_pedido) // activo la acción draggable para el duplicado
        .draggable({
          listeners: {
            start: setInitialCoords,
            move : dragMoveListener,
            end : onDropCheck
          }
        });
        event.target.remove(); //elimino el original que quedó flotando fuera del listado
        dragging = false;
      }
    }
    interact('.pedido')
    .draggable({
      listeners: {
        start: setInitialCoords,
        move : dragMoveListener,
        end : onDropCheck
      }
    });

    // seteo las maquinas como dropzones para pedidos
    interact('.maquina').dropzone({
      // only accept elements matching this CSS selector
      accept: '.pedido',
      // Require a 50% element overlap for a drop to be possible
      overlap: 0.5,

      // listen for drop related events:
      ondropactivate: function (event) {
        // add active dropzone feedback
        event.target.classList.add('drop-active')
      },
      ondragenter: function (event) {
        let dropzoneElement = event.target

        // feedback the possibility of a drop
        dropzoneElement.classList.add('drop-target');
      },
      ondragleave: function (event) {
        // remove the drop feedback style
        event.target.classList.remove('drop-target');
      },
      ondrop: function (event) {
        dragging = false;
        duplicate_pedido.remove();// cuando se suelta dentro de una maquina, elimino el duplicado que esta en el listado
        let pedidoAsignado = event.target.querySelector(".pedidoAsignado");
        let texto = event.target.querySelector(".card-text");
        event.relatedTarget.style.transform = ''
        event.relatedTarget.style.position = '';
        pedidoAsignado.appendChild(event.relatedTarget);// muestro el que solté en la maquina actual
        texto.classList.add("d-none");
        pedidoAsignado.classList.remove('d-none');
        event.target.classList.add('activa');
      },
      ondropdeactivate: function (event) {
        // remove active dropzone feedback
        event.target.classList.remove('drop-active');
        event.target.classList.remove('drop-target');
      }
    })
  </script>
<script>
</script>
</div>
</body>
</html>