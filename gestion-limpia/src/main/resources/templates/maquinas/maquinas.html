<!DOCTYPE html>
<!--suppress RequiredAttributes -->
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="maquinas(lavadorasPedidosMap, secadorasPedidosMap)" class="col-8 container-maquinas">
  <div class="row">
    <div class="col-6 border-start border-end border-black border-2" >
      <h5 class="text-center">LAVADO</h5>
      <div class="row">
        <!-- lavadoras -->
        <div class="col-6" th:each="maquinaLavadora : ${lavadorasPedidosMap}" >
          <div th:class="${'card p-0 col-12 user-select-none maquina lavadora '+(maquinaLavadora.value != null ? 'activa':'')}"  data-tipo="lavadora">
            <div th:text="${'Lavadora '+ maquinaLavadora.key}" class="card-header"></div>
            <div class="card-body d-flex justify-content-center">
              <p class="sin-pedido-text card-text h6 text-muted text-center m-0 p-0 mt-5 position-absolute">Sin pedido asignado</p>
              <ul class="pedido-asignado" data-tipo="lavadora">
                <li th:if="${maquinaLavadora.value != null}" th:with="pedido = ${maquinaLavadora.value}" role="button" th:class="'pedido card my-2 border-2 user-select-none  ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE || pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).PRIORITARIO ? 'border-danger rounded-3' : ''}">
                  <div th:text="${'Pedido ' + pedido.id}" th:class="'p-0 card-header text-center ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE ? 'bg-danger' : (pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).PRIORITARIO ? 'bg-danger-subtle':'')}"></div>
                  <div th:class="'p-0 card-body ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE? 'bg-danger-subtle' : ''}">
                    <p class="px-2 py-1 card-text">
                      <span th:text="'• '+${pedido.tipo.descripcion}"></span><br/>
                      <span th:text="'• '+${pedido.cliente.nombreApellido}"></span>
                      <input class="pedidoId" type="hidden" th:value="${pedido.id}">
                    </p>
                  </div>
                  <div th:class="'p-0 card-footer text-center text-muted ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE ? 'bg-danger' : (pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).PRIORITARIO ? 'bg-danger-subtle':'')}">
                    <small th:text="${#dates.format(pedido.fechaHoraIngreso, 'dd/MM/yyyy')}"></small>
                  </div>
                </li>
              </ul>
              <input type="hidden" class="maquinaNumero" th:value="${maquinaLavadora.key}">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-6 border-end border-black border-2" >
      <h5 class="text-center">SECADO</h5>
      <div class="row">
        <div class="col-6" th:each="maquinaSecadora : ${secadorasPedidosMap}" >
            <!-- secadoras -->
              <div th:class="${'card p-0 col-12 user-select-none maquina secadora '+(maquinaSecadora.value != null ? 'activa':'')}" data-tipo="secadora">
                <div th:text="${'Secadora '+ maquinaSecadora.key}" class="card-header"></div>
                <div class="card-body d-flex justify-content-center">
                  <p class="sin-pedido-text card-text h6 text-muted text-center m-0 p-0 mt-5 position-absolute">Sin pedido asignado</p>
                  <ul class="pedido-asignado" data-tipo="secadora">
                    <li th:if="${maquinaSecadora.value != null}" th:with="pedido = ${maquinaSecadora.value}" role="button" th:class="'pedido card my-2 border-2 user-select-none  ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE || pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).PRIORITARIO ? 'border-danger rounded-3' : ''}">
                      <div th:text="${'Pedido ' + pedido.id}" th:class="'p-0 card-header text-center ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE ? 'bg-danger' : (pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).PRIORITARIO ? 'bg-danger-subtle':'')}"></div>
                      <div th:class="'p-0 card-body ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE? 'bg-danger-subtle' : ''}">
                        <p class="px-2 py-1 card-text">
                          <span th:text="'• '+${pedido.tipo.descripcion}"></span><br/>
                          <span th:text="'• '+${pedido.cliente.nombreApellido}"></span>
                          <input class="pedidoId" type="hidden" th:value="${pedido.id}">
                        </p>
                      </div>
                      <div th:class="'p-0 card-footer text-center text-muted ' + ${pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).URGENTE ? 'bg-danger' : (pedido.prioridad == T(com.burbujas.gestionlimpia.models.entities.enums.Prioridad).PRIORITARIO ? 'bg-danger-subtle':'')}">
                        <small th:text="${#dates.format(pedido.fechaHoraIngreso, 'dd/MM/yyyy')}"></small>
                      </div>
                    </li>
                  </ul>
                  <input type="hidden" class="maquinaNumero" th:value="${maquinaSecadora.key}">
                </div>
              </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:fragment="pedidos_js">
  <script src="webjars/interactjs/1.10.17/dist/interact.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function(evt){
      // hago pedidos draggables
      var dragging = false;
      var duplicate_pedido;
      var last_maquina_tipo;
      var last_maquina;
      function dragMoveListener (event) {
        // permite mover los pedidos
        if(!dragging){
          duplicate_pedido = event.target.cloneNode(true);
          duplicate_pedido.setAttribute('disabled',true);
          event.target.after(duplicate_pedido);
          //aplico estilos al duplicado, para que sea vea debajo del que estoy arrastrando, que este gris y no desplace los pedidos siguientes
          duplicate_pedido.style.cssText = 'zIndex:0;transform:translateY(-'+(12+duplicate_pedido.offsetHeight)+'px);margin-bottom:-'+(8+duplicate_pedido.offsetHeight)+'px !important;filter:brightness(50%)';
          dragging = true;
        }
        let target = event.target;
        target.style.zIndex = '10';

        // keep the dragged position in the data-x/data-y attributes
        let x = parseFloat(target.getAttribute('data-x')) + event.dx;
        let y = parseFloat(target.getAttribute('data-y')) + event.dy;

        // translate the element
        target.style.transform = 'translate(' + x + 'px, ' + y + 'px)'

        // update the position attributes
        target.setAttribute('data-x', x)
        target.setAttribute('data-y', y)
      }
      function setInitialCoords(event){
          event.target.setAttribute('data-x', parseFloat(0));
          event.target.setAttribute('data-y', parseFloat(0));
          last_maquina =event.target.parentNode.parentNode.parentNode;
          last_maquina_tipo = event.target.parentNode.dataset.tipo;
      }
      function onDropCheck(event){
        if(dragging){ // si no se soltó dentro de una máquina, el duplicado reemplaza el original y borro el original
          duplicate_pedido.style.cssText = 'zIndex:10;';
          duplicate_pedido.removeAttribute('disabled');
          interact(duplicate_pedido) // activo la acción draggable para el duplicado
          .draggable({
            listeners: {
              start: setInitialCoords,
              move : dragMoveListener,
              end : onDropCheck
            }
          });
          event.target.remove(); //elimino el original que quedó flotando fuera del listado
          dragging = false;
        }
      }
      interact('.pedido')
      .draggable({
        listeners: {
          start: setInitialCoords,
          move : dragMoveListener,
          end : onDropCheck
        }
      });

      // seteo las maquinas como dropzones para pedidos
      interact('.maquina').dropzone({
        // only accept elements matching this CSS selector
        accept: '.pedido',
        // Require a 50% element overlap for a drop to be possible
        overlap: 0.5,

        // listen for drop related events:
        ondropactivate: function (event) {
          // add active dropzone feedback
          event.target.classList.add('drop-active');
        },
        ondragenter: function (event) {
          let dropzoneElement = event.target
          // feedback the possibility of a drop
          dropzoneElement.classList.add('drop-target');
        },
        ondragleave: function (event) {
          // remove the drop feedback style
          event.target.classList.remove('drop-target');
        },
        ondrop: function (event) {
          // event.target es el pedido
          // event relatedTarget es la maquina
          dragging = false;
          event.relatedTarget.style.transform = ''
          event.relatedTarget.style.position = '';
          duplicate_pedido.remove();// cuando se suelta dentro de una maquina, elimino el duplicado que esta en el listado

          let misma_maquina = last_maquina_tipo === event.target.dataset.tipo;
          if(misma_maquina){
            //si lo agarré y solté dentro del mismo tipo de máquina, aviso y no hago nada
            notyf.open({
              type: 'error',
              message: 'El pedido ya se encuentra asignado a una ' + last_maquina_tipo
            });
            return;
          }
          let pedidoAsignado = event.target.querySelector(".pedido-asignado");
          pedidoAsignado.appendChild(event.relatedTarget);// muestro el que solté en la maquina actual
          pedidoAsignado.classList.remove('d-none');
          event.target.classList.add('activa');
          last_maquina.classList.remove('activa');

          let pedidoId = pedidoAsignado.querySelector(".pedidoId").value;
          let maquinaNumero = event.target.querySelector(".maquinaNumero").value;

          // trigger del cambio de estado en el pedido
          asignarPedidoAMaquina(pedidoId, maquinaNumero, forzar=false);

          // si no hay mas pedidos por realizar muestro texto dentro del contenedor de pedidos
          if($(".container-pedidos #pedidosList").children().length > 0){
            $(".container-pedidos #sinPedidos").addClass("d-none");
          }else{
            $(".container-pedidos #sinPedidos").removeClass("d-none");
          }
        },
        ondropdeactivate: function (event) {
          // remove active dropzone feedback
          event.target.classList.remove('drop-active');
          event.target.classList.remove('drop-target');
        }
      });

      interact('.container-pedidos').dropzone({
          // only accept elements matching this CSS selector
          accept: '.pedido',
          // Require a 35% element overlap for a drop to be possible
          overlap: 0.35,

          // listen for drop related events:
          ondropactivate: function (event) {
            // add active dropzone feedback
            event.target.classList.add('drop-active')
          },
          ondragenter: function (event) {
            // feedback the possibility of a drop
            event.target.classList.add('drop-target');
          },
          ondragleave: function (event) {
            // remove the drop feedback style
            event.target.classList.remove('drop-target');
          },
          ondrop: function (event) {
            dragging = false;
            // event.target es container-pedidos
            // event.relatedTarget es el pedido arrastrado
            duplicate_pedido.remove();// cuando se suelta en el listado, elimino el duplicado que esta dentro de una maquina
            event.relatedTarget.style.transform = ''
            event.relatedTarget.style.position = '';

            let misma_maquina = last_maquina_tipo === event.target.dataset.tipo;

            if(misma_maquina){
              //si lo agarré y solté dentro del mismo container de pedidos, no hago nada
              return;
            }

            event.target.querySelector("#pedidosList").appendChild(event.relatedTarget);// muestro el que solté en el listado de pendientes

            let pedidoId = event.relatedTarget.querySelector(".pedidoId").value;

            // trigger del cambio de estado en el pedido
            cambiarEstadoPedido(pedidoId, "PENDIENTE");

            // oculto texto de que no hay pedidos
            $(".container-pedidos #sinPedidos").addClass("d-none");
          },
          ondropdeactivate: function (event) {
            event.target.classList.remove('drop-active');
            event.target.classList.remove('drop-target');
          }
      });

      interact('.finalizar').dropzone({
        accept: '.pedido',
        overlap: 0.5,
        ondropactivate: function (event) {
          event.target.classList.add('drop-active')
        },
        ondragenter: function (event) {
          let dropzoneElement = event.target
          dropzoneElement.classList.add('drop-target');
        },
        ondragleave: function (event) {
          event.target.classList.remove('drop-target');
        },
        ondrop: function (event) {
          if(window.confirm("¿Finalizar el pedido?")) {
            // event.target es la máquina de finalización
            // event.relatedTarget es el pedido arrastrado
            dragging = false;
            duplicate_pedido.remove();// cuando se finaliza, elimino el duplicado que esta dentro de una maquina
            event.relatedTarget.style.transform = ''
            event.relatedTarget.style.position = '';

            let pedidoId = event.relatedTarget.querySelector(".pedidoId").value;

            // trigger del cambio de estado en el pedido
            cambiarEstadoPedido(pedidoId, "FINALIZADO");
          }
        },
        ondropdeactivate: function (event) {
          // remove active dropzone feedback
          event.target.classList.remove('drop-active');
          event.target.classList.remove('drop-target');
        }
      });
      interact('.cancelar').dropzone({
        accept: '.pedido',
        overlap: 0.5,
        ondropactivate: function (event) {
          event.target.classList.add('drop-active')
        },
        ondragenter: function (event) {
          let dropzoneElement = event.target
          dropzoneElement.classList.add('drop-target');
        },
        ondragleave: function (event) {
          event.target.classList.remove('drop-target');
        },
        ondrop: function (event) {
          if(window.confirm("¿Cancelar el pedido?")) {
            // event.target es la máquina de cancelación
            // event.relatedTarget es el pedido arrastrado
            dragging = false;
            duplicate_pedido.remove();// cuando se finaliza, elimino el duplicado que esta dentro de una maquina
            event.relatedTarget.style.transform = ''
            event.relatedTarget.style.position = '';

            let pedidoId = event.relatedTarget.querySelector(".pedidoId").value;

            // trigger del cambio de estado en el pedido
            cambiarEstadoPedido(pedidoId, "CANCELADO");
          }
        },
        ondropdeactivate: function (event) {
          // remove active dropzone feedback
          event.target.classList.remove('drop-active');
          event.target.classList.remove('drop-target');
        }
      });
    });

    const asignarPedidoAMaquina = (pedidoId, maquinaNumero, forzar) => {
      $.ajax({
        type : "POST",
        contentType : "application/json",
        url : "/pedidos/"+pedidoId+"/maquina/"+maquinaNumero+"/"+forzar,
        dataType: 'json',
        success : function(result) {
          console.log(result.msg);
          if (result.status === "ERROR") {
            alert("ERROR");
            console.log(result);
            // volver ponerlo en la máquina que estaba antes
          }
          if(result.status === "REPETIDO"){
            // si HttpStatus es OK pero result.status es REPETIDO,
            // es pq ya pasó por este estado... pregunto si quiere repetirlo
            if(confirm(result.msg)){
              asignarPedidoAMaquina(pedidoId, maquinaNumero, true);
            }
          }
        },
        error : function(e) {
          alert(e)
        }
      });
    }

    const cambiarEstadoPedido = (pedidoId, estado) => {
      $.ajax({
        type : "POST",
        contentType : "application/json",
        url : "/pedidos/"+pedidoId+"/estado/"+estado,
        dataType: 'json',
        success : function(result) {
          if (result.status !== "OK") {
            //si hay error, mostrarlo por pantalla y volver a poner el pedido en el listado de pendientes
          }
        },
        error : function(e) {
          alert(e)
        }
      });
    }
  </script>
<script>
</script>
</div>
</body>
</html>